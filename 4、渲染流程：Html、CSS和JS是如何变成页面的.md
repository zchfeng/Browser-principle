## HTML、CSS、JS 渲染流水线

### 构建 DOM 树

#### 为什么要构建 DOM 树？ 这是因为浏览器无法直接理解和使用 HTML，所以需要将 HTML 转换为浏览器能够理解的结构-DOM 树。

#### 构建 DOM 树的输入内容是一个简单的 HTML 文件，然后经由 HTML 解析器解析，最终输出树状结构的 DOM。

#### DOM 和 HTML 内容机会一样的，但是和 HTML 不同的是，DOM 是保存在内存中树状结构，可以通过 JS 来查询或修改其内容。

### 样式计算

#### 1、把 CSS 转换为浏览器能够理解的结构：当渲染引擎接收到 CSS 文件时，会执行一个转换操作，将 CSS 文件转换为浏览器可以理解的结构——styleSheets.

#### 2、转换样式表中的属性，使其标准化：将所有值转换为渲染引起容易理解的、标准的计算值。（比如 2em，blue、bold）

#### 3、计算出 DOM 树中每个节点的具体样式：这里涉及到 CSS 的继承规则和层叠规则了。

### 布局阶段：计算出 DOM 树中可见元素的几何位置，我们把这个计算过程叫布局。

#### 1、创建布局树：在显示之前，需要构建一颗只包含可见元素布局树。

#### 2、布局计算

- 2.1、分层：渲染引擎需要为特点的节点生成专用的图层，并生成一颗对应的图层树
- 2.2、图层绘制：图层绘制阶段，输出的内容就是这些待绘制列表。绘制列表只用来记录绘制顺序和绘制指令列表。
- 2.3、栅格化操作：实际的绘制操作是由渲染引擎中的合成线程完成的。合成线程会将图层划分为图块，然后合成线程会按照视图附近的图块优先生成位图，实际生成位图的操作是由栅格化来执行的。所谓栅格化，是指将图块转换为位图。
- 2.4、合成和显示：一旦所有图块都被光栅化，合成线程就会生成一个绘制图块的命令——“DrawQuad”，然后将该命令提交给浏览器进程。浏览器接收到 DrawQuad 命令后，根据命令将页面内容绘制到内容中，最后将内存显示到屏幕上。

## 完成的渲染流程大致总结如下：

### 1.渲染进程将 HTML 内容转换为浏览器能够读懂的 DOM 树结构

### 2.渲染引擎将 CSS 样式表转换为浏览器能理解的 styleSheets，计算出 DOM 节点的样式。

### 3. 创建布局树，并计算元素的布局信息。

### 4.对布局树进行分层，并生成分层树。

### 5.为每个图层生成绘制列表，并将其提交到合成线程。

### 6.合成线程将图层分成图块，并在光栅化线程池中将图块转换成位图。

### 7.合成线程发送绘制图块命令 DrawQuad 给浏览器进程。

### 8.浏览器进程根据 DrawQuad 消息生成页面，并显示到显示器上。
